{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-success"><i class="fas fa-wind me-2"></i>生态环境监测</h2>
</div>

<ul class="nav nav-tabs mb-4" id="envTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#data-pane">监测数据</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#index-pane">指标库</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#device-pane">设备管理</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#area-pane">区域信息</button></li>
</ul>

<div class="tab-content">
    <!-- 1. 数据 -->
    <div class="tab-pane fade show active" id="data-pane">
        <div class="d-flex justify-content-end mb-3"><button class="btn btn-park" onclick="openAddModal('addDataModal', '/env/add')">新增数据</button></div>
        <div class="card p-3 shadow-sm border-0">
            <table class="table table-hover table-park align-middle">
                <thead><tr><th>ID</th><th>指标</th><th>数值</th><th>时间</th><th>区域</th><th>质量</th><th>操作</th></tr></thead>
                <tbody>
                    {% for d in data_list %}
                    <tr>
                        <td>{{ d.data_id }}</td>
                        <td>{{ d.index_info.index_name if d.index_info else d.index_id }}</td>
                        <td>{{ d.monitor_value }}</td>
                        <td>{{ d.collect_time.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ d.area_info.area_name if d.area_info else d.area_id }}</td>
                        <td><span class="badge {{ 'bg-success' if d.data_quality=='优' else 'bg-danger' }}">{{ d.data_quality }}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditModal('env', 'data', '{{ d.data_id }}', 'addDataModal')">修改</button>
                            <a href="/generic/env/data/delete/{{ d.data_id }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('删？')">删除</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 2. 指标 -->
    <div class="tab-pane fade" id="index-pane">
        <div class="d-flex justify-content-end mb-3"><button class="btn btn-park" onclick="openAddModal('addIndexModal', '/generic/env/index/add')">新增指标</button></div>
        <div class="card p-3 shadow-sm border-0">
            <table class="table table-hover align-middle">
                <thead><tr><th>ID</th><th>名称</th><th>单位</th><th>阈值</th><th>频率</th><th>操作</th></tr></thead>
                <tbody>
                    {% for i in indexes %}
                    <tr>
                        <td>{{ i.index_id }}</td>
                        <td>{{ i.index_name }}</td>
                        <td>{{ i.unit }}</td>
                        <td>{{ i.standard_lower or '-' }} ~ {{ i.standard_upper or '-' }}</td>
                        <td>{{ i.monitor_frequency }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditModal('env', 'index', '{{ i.index_id }}', 'addIndexModal')">修改</button>
                            <a href="/generic/env/index/delete/{{ i.index_id }}" class="btn btn-sm btn-outline-danger">删除</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 3. 设备 -->
    <div class="tab-pane fade" id="device-pane">
        <div class="d-flex justify-content-end mb-3"><button class="btn btn-park" onclick="openAddModal('addDeviceModal', '/generic/env/device/add')">新增设备</button></div>
        <div class="card p-3 shadow-sm border-0">
            <table class="table table-hover align-middle">
                <thead><tr><th>ID</th><th>类型</th><th>安装时间</th><th>状态</th><th>操作</th></tr></thead>
                <tbody>
                    {% for d in devices %}
                    <tr>
                        <td>{{ d.device_id }}</td>
                        <td>{{ d.device_type }}</td>
                        <td>{{ d.install_time }}</td>
                        <td>{{ d.running_status }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditModal('env', 'device', '{{ d.device_id }}', 'addDeviceModal')">修改</button>
                            <a href="/generic/env/device/delete/{{ d.device_id }}" class="btn btn-sm btn-outline-danger">删除</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 4. 区域 -->
    <div class="tab-pane fade" id="area-pane">
        <div class="d-flex justify-content-end mb-3"><button class="btn btn-park" onclick="openAddModal('addAreaModal', '/generic/env/area/add')">新增区域</button></div>
        <div class="card p-3 shadow-sm border-0">
            <table class="table table-hover align-middle">
                <thead><tr><th>ID</th><th>名称</th><th>级别</th><th>经纬范围</th><th>操作</th></tr></thead>
                <tbody>
                    {% for a in areas %}
                    <tr>
                        <td>{{ a.area_id }}</td>
                        <td>{{ a.area_name }}</td>
                        <td>{{ a.area_level }}</td>
                        <td><small>E:{{ a.area_lng_range }}<br>N:{{ a.area_lat_range }}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditModal('env', 'area', '{{ a.area_id }}', 'addAreaModal')">修改</button>
                            <a href="/generic/env/area/delete/{{ a.area_id }}" class="btn btn-sm btn-outline-danger">删除</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="addDataModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header card-header-park"><h5 class="modal-title">新增数据</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form action="/env/add" method="POST"> 
                <div class="modal-body">
                    <input name="data_id" class="form-control mb-2" placeholder="ID" required>
                    <select name="index_id" class="form-select mb-2">{% for i in indexes %}<option value="{{ i.index_id }}">{{ i.index_name }}</option>{% endfor %}</select>
                    <input name="monitor_value" type="number" step="0.01" class="form-control mb-2" placeholder="数值" required>
                    <select name="area_id" class="form-select mb-2">{% for a in areas %}<option value="{{ a.area_id }}">{{ a.area_name }}</option>{% endfor %}</select>
                    <select name="device_id" class="form-select mb-2">{% for d in devices %}<option value="{{ d.device_id }}">{{ d.device_type }}</option>{% endfor %}</select>
                    <input name="collect_time" type="datetime-local" class="form-control mb-2" required>
                </div>
                <div class="modal-footer"><button class="btn btn-park">提交</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addIndexModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header card-header-park"><h5 class="modal-title">新增指标</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form action="/generic/env/index/add" method="POST">
                <div class="modal-body">
                    <input name="index_id" class="form-control mb-2" placeholder="ID" required>
                    <input name="index_name" class="form-control mb-2" placeholder="名称" required>
                    <input name="unit" class="form-control mb-2" placeholder="单位">
                    <input name="standard_upper" type="number" step="0.01" class="form-control mb-2" placeholder="上限">
                    <input name="standard_lower" type="number" step="0.01" class="form-control mb-2" placeholder="下限">
                    <input name="monitor_frequency" class="form-control mb-2" placeholder="频率">
                </div>
                <div class="modal-footer"><button class="btn btn-park">提交</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addDeviceModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header card-header-park"><h5 class="modal-title">新增设备</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form action="/generic/env/device/add" method="POST">
                <div class="modal-body">
                    <input name="device_id" class="form-control mb-2" placeholder="ID" required>
                    <input name="device_type" class="form-control mb-2" placeholder="类型" required>
                    <select name="deploy_area_id" class="form-select mb-2">{% for a in areas %}<option value="{{ a.area_id }}">{{ a.area_name }}</option>{% endfor %}</select>
                    <input name="install_time" type="date" class="form-control mb-2" required>
                    <input name="calibration_cycle" type="number" class="form-control mb-2" placeholder="周期">
                    <input name="running_status" class="form-control mb-2" value="正常">
                    <input name="communication_protocol" class="form-control mb-2" value="4G">
                </div>
                <div class="modal-footer"><button class="btn btn-park">提交</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addAreaModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header card-header-park"><h5 class="modal-title">新增区域</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <form action="/generic/env/area/add" method="POST">
                <div class="modal-body">
                    <input name="area_id" class="form-control mb-2" placeholder="ID" required>
                    <input name="area_name" class="form-control mb-2" placeholder="名称" required>
                    <select name="area_level" class="form-select mb-2"><option>核心保护区</option><option>一般控制区</option></select>
                    <input name="area_lng_range" class="form-control mb-2" placeholder="经度范围">
                    <input name="area_lat_range" class="form-control mb-2" placeholder="纬度范围">
                </div>
                <div class="modal-footer"><button class="btn btn-park">提交</button></div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function(){
        var hash = window.location.hash;
        if (hash) { var el = document.querySelector('button[data-bs-target="' + hash + '"]'); if(el) new bootstrap.Tab(el).show(); }
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(el => el.addEventListener('shown.bs.tab', e => history.pushState(null, null, e.target.getAttribute('data-bs-target'))));
    });

    function openAddModal(modalId, actionUrl) {
        var modalEl = document.getElementById(modalId);
        var form = modalEl.querySelector('form');
        form.reset();
        form.action = actionUrl;
        modalEl.querySelector('.modal-title').textContent = "新增数据";
        form.querySelectorAll('input, select').forEach(el => el.readOnly = false);
        new bootstrap.Modal(modalEl).show();
    }

    function openEditModal(module, key, id, modalId) {
        var modalEl = document.getElementById(modalId);
        var form = modalEl.querySelector('form');
        form.reset();
        
        fetch(`/generic/${module}/${key}/get/${id}`)
            .then(res => {
                if (!res.ok) throw new Error("HTTP error " + res.status);
                return res.json();
            })
            .then(data => {
                if(data.error) { alert(data.error); return; }
                for (const [k, v] of Object.entries(data)) {
                    let input = form.querySelector(`[name="${k}"]`);
                    if (input) input.value = v;
                }
                let firstInput = form.querySelector('input');
                if(firstInput) firstInput.readOnly = true;

                form.action = `/generic/${module}/${key}/update`;
                modalEl.querySelector('.modal-title').textContent = "编辑数据 (ID: " + id + ")";
                new bootstrap.Modal(modalEl).show();
            })
            .catch(err => alert("加载失败: " + err));
    }
</script>
{% endblock %}